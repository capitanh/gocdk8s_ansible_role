---
- name: Install requrided pakages
  apt:
    name:
      - pip

- name: Install pip packages
  pip:
    name:
      - kubernetes

- name: Create gocd folders
  file:
    path: "{{gocd_data_dir}}"
    state: directory
    owner: "{{admin_user}}"
    group: "{{admin_user}}"
    mode: 0777

- name: Create k8s resources
  kubernetes.core.k8s:
    template:
    - ns.yml
    - pv.yml
    - pvc.yml
  become_user: "{{admin_user}}"

- name: Install gocd helm chart
  kubernetes.core.helm:
    release_name: "{{gocd_app_name}}"
    chart_ref: gocd
    chart_repo_url: https://gocd.github.io/helm-chart
    release_namespace: "{{k8s_namespace}}"
    wait: yes
    values_files:
      - /tmp/values.yml
  become_user: "{{admin_user}}"

#- name: Wait until gocd pod is ready
#  kubernetes.core.k8s:
#    name:
#    kind: pod
#    namespace: "{{k8s_namespace}}"
#    wait: yes
#    wait_condition:
#      type: Ready